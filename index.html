<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ai Là Siêu Anh Hùng Lớp Mình?</title>

  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.8.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.8.2/firebase-database-compat.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Baloo 2', sans-serif;
      background: linear-gradient(135deg, #a29bfe 0%, #ffeaa7 100%);
      min-height: 100vh;
      padding: 15px 10px;
      text-align: center;
    }
    .container {
      max-width: 520px;
      margin: 0 auto;
      background: white;
      border-radius: 30px;
      padding: 30px 20px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
    }
    h1 {
      font-size: 2.8em;
      margin: 10px 0 15px;
      color: #6c5ce7;
      text-shadow: 3px 3px 0px #fd79a8;
    }
    .subtitle {
      font-size: 1.55em;
      margin-bottom: 25px;
      color: #e84393;
      line-height: 1.4;
    }
    #timer {
      font-size: 5em;
      font-weight: 800;
      color: #d63031;
      background: #fff0f0;
      padding: 15px;
      border-radius: 25px;
      margin: 20px 0;
    }
    #timer.urgent { animation: blink 0.8s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    .options { display: flex; flex-direction: column; gap: 18px; margin: 30px 0; }
    .option {
      background: #ddd;
      border-radius: 28px;
      padding: 30px 15px;
      cursor: pointer;
      font-size: 1.8em;
      font-weight: 700;
      color: white;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      transition: all 0.3s;
    }
    .option:hover { transform: translateY(-10px) scale(1.04); }
    .option:active { transform: scale(0.96); }
    .option.selected {
      transform: scale(1.08);
      box-shadow: 0 0 50px #ffd700, 0 0 100px #ff0 !important;
      animation: pulse 1.5s infinite;
    }
    .option.disabled { opacity: 0.35; pointer-events: none; filter: grayscale(90%); }
    .nickname {
      font-size: 0.75em;
      opacity: 0.95;
      margin-top: 6px;
      font-weight: 600;
    }
    #message {
      font-size: 1.9em;
      min-height: 70px;
      padding: 15px;
      background: #fff3cd;
      border-radius: 20px;
      margin: 20px 0;
      color: #e17055;
      font-weight: 700;
    }
    .result-item {
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      color: white;
      margin: 18px 0;
      padding: 22px;
      border-radius: 25px;
      display: flex;
      align-items: center;
      font-size: 1.7em;
      box-shadow: 0 12px 35px rgba(0,0,0,0.3);
    }
    .rank { font-size: 4.5em; margin-right: 20px; }
    .progress { height: 35px; background: rgba(255,255,255,0.3); border-radius: 20px; overflow: hidden; margin-top: 12px; }
    .bar { height: 100%; background: #fff; border-radius: 20px; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,215,0,0.8); } 70% { box-shadow: 0 0 0 40px rgba(255,215,0,0); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI LÀ SIÊU ANH HÙNG LỚP MÌNH?</h1>
    <div class="subtitle">Bấm vào tên bạn mà bạn tin có siêu năng lực bí mật!</div>

    <button id="resetBtn" style="display:none;background:#e17055;color:white;border:none;padding:15px 30px;font-size:1.5em;border-radius:20px;margin:15px;">
      RESET POLL (Chỉ cô/thầy)
    </button>

    <div id="timer">02:00</div>
    <div id="message">Chọn ngay một người nào!</div>

    <div id="poll" class="options"></div>

    <div id="results" style="display:none;">
      <h2 style="font-size:3.2em;color:#f1c40f;margin:30px 0">BẢNG VÀNG SIÊU ANH HÙNG</h2>
      <div id="ranking"></div>
      <p style="font-size:1.8em;margin-top:25px">Tổng cộng <b id="total-votes">0</b> bạn đã vote</p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAQB47nB58LyMQ1_5DZSCggJK5AhBy-POE",
      authDomain: "poll-sieu-nang-luc.firebaseapp.com",
      databaseURL: "https://poll-sieu-nang-luc-default-rtdb.firebaseio.com",
      projectId: "poll-sieu-nang-luc",
      storageBucket: "poll-sieu-nang-luc.firebasestorage.app",
      messagingSenderId: "743139357944",
      appId: "1:743139357944:web:92fe5cfc03d4414e5e370d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const pollRef = db.ref('sieunangluc-tenhocsinh-2025');
    const votesRef = pollRef.child('votes');
    const endTimeRef = pollRef.child('endTime');
    const duration = 120; // 2 phút

    // 30 học sinh – TÊN TRƯỚC, BIỆT DANH SAU
    const students = [
      {id:0,  name:"Minh Khang",    nickname:"Cậu Bé Tia Chớp",      color:"#74b9ff"},
      {id:1,  name:"Bảo Châu",     nickname:"Phù Thủy Phép Thuật",   color:"#fd79a8"},
      {id:2,  name:"Phương Nam",   nickname:"Siêu Nhân Mặt Trời",    color:"#f1c40f"},
      {id:3,  name:"Ngọc Ánh",     nickname:"Công Chúa Băng Giá",    color:"#81ecec"},
      {id:4,  name:"Tuấn Kiệt",    nickname:"Siêu Nhân Cơ Bắp",      color:"#e17055"},
      {id:5,  name:"Hải Đăng",     nickname:"Người Dẫn Đường",       color:"#00b894"},
      {id:6,  name:"Thảo Vy",      nickname:"Nữ Hoàng Hoa",          color:"#ff7675"},
      {id:7,  name:"Khánh Linh",   nickname:"Thiên Thần Nhỏ",        color:"#a29bfe"},
      {id:8,  name:"Trí Đức",      nickname:"Thần Đồng Não Bộ",      color:"#6c5ce7"},
      {id:9,  name:"Yến Nhi",      nickname:"Phượng Hoàng Lửa",      color:"#fdcb6e"},
      {id:10, name:"Hoàng Long",   nickname:"Rồng Vàng Bay",         color:"#e84393"},
      {id:11, name:"Mai Anh",      nickname:"Bướm Tiên Nữ",          color:"#fd79a8"},
      {id:12, name:"Đức Huy",      nickname:"Hiệp Sĩ Ánh Sáng",      color:"#0984e3"},
      {id:13, name:"Thùy Linh",    nickname:"Tiên Nữ Gió",           color:"#00cec9"},
      {id:14, name:"Phong",        nickname:"Thần Gió Lốc",          color:"#636e72"},
      {id:15, name:"Hồng Ngọc",    nickname:"Nữ Hoàng Lửa",          color:"#d63031"},
      {id:16, name:"Quốc Bảo",     nickname:"Người Bảo Vệ Lớp",      color:"#2d3436"},
      {id:17, name:"Kim Ngân",     nickname:"Công Chúa Bạc",         color:"#b2bec3"},
      {id:18, name:"Việt Hoàng",   nickname:"Vua Chiến Binh",        color:"#e17055"},
      {id:19, name:"Lan Chi",      nickname:"Hoa Lan Tiên Tử",       color:"#ff7675"},
      {id:20, name:"Minh Tuấn",    nickname:"Tia Sét Siêu Tốc",      color:"#74b9ff"},
      {id:21, name:"Thảo Nguyên",  nickname:"Nữ Hoàng Thảo Nguyên",  color:"#00b894"},
      {id:22, name:"Hà My",       nickname:"Nàng Tiên Cá",          color:"#81ecec"},
      {id:23, name:"Trọng Nghĩa",  nickname:"Hiệp Sĩ Công Lý",       color:"#2ecc71"},
      {id:24, name:"Diệu Linh",    nickname:"Tiên Nữ Ánh Trăng",     color:"#a29bfe"},
      {id:25, name:"Khánh An",     nickname:"Thiên Thần Bình Yên",   color:"#fdcb6e"},
      {id:26, name:"Tùng Lâm",     nickname:"Người Gác Rừng",        color:"#55a3ff"},
      {id:27, name:"Bích Thủy",    nickname:"Nàng Tiên Nước",        color:"#00cec9"},
      {id:28, name:"Nhật Minh",    nickname:"Mặt Trời Bé Nhỏ",       color:"#f1cCounts40f"},
      {id:29, name:"Cát Tường",    nickname:"Phù Thủy May Mắn",      color:"#e84393"}
    ];

    let endTime = null;
    let votes = {};
    const pollDiv = document.getElementById('poll');
    const timerDiv = document.getElementById('timer');
    const messageDiv = document.getElementById('message');
    const rankingDiv = document.getElementById('ranking');
    const totalSpan = document.getElementById('total-votes');

    // Tạo các ô vote: Tên lớn trước – biệt danh nhỏ sau
    students.forEach(s => {
      const div = document.createElement('div');
      div.className = 'option';
      div.dataset.id = s.id;
      div.style.background = s.color;
      div.innerHTML = `
        <div>${s.name}</div>
        <div class="nickname">${s.nickname}</div>
      `;
      div.onclick = () => vote(s.id);
      pollDiv.appendChild(div);
    });

    // Kiểm tra đã vote chưa
    if (localStorage.getItem('voted_ten_2025') === 'yes') {
      const chosen = localStorage.getItem('choice_ten_2025');
      document.querySelectorAll('.option').forEach(d => {
        if (d.dataset.id == chosen) d.classList.add('selected');
        else d.classList.add('disabled');
      });
      messageDiv.innerHTML = `Bạn đã vote cho <b>${students[chosen].name}</b> rồi nha!`;
    }

    endTimeRef.on('value', snap => {
      endTime = snap.val();
      if (endTime && Date.now() > endTime) showResults();
      else updateTimer();
    });

    votesRef.on('value', snap => {
      votes = snap.val() || {};
      if (Date.now() > endTime) showResults();
    });

    function vote(id) {
      if (localStorage.getItem('voted_ten_2025') === 'yes' || (endTime && Date.now() > endTime)) return;

      votesRef.child(id).transaction(v => (v||0)+1);
      localStorage.setItem('voted_ten_2025','yes');
      localStorage.setItem('choice_ten_2025',id);

      messageDiv.innerHTML = `Vote cho <b>${students[id].name}</b> thành công!`;
      confetti({particleCount:250, spread:100});
      new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3').play().catch(()=>{});

      document.querySelectorAll('.option').forEach(d => {
        if (d.dataset.id == id) d.classList.add('selected');
        else d.classList.add('disabled');
      });
    }

    function updateTimer() {
      const left = Math.max(0, (endTime - Date.now())/1000);
      const m = String(Math.floor(left/60)).padStart(2,'0');
      const s = String(Math.floor(left%60)).padStart(2,'0');
      timerDiv.textContent = `${m}:${s}`;
      timerDiv.classList.toggle('urgent', left < 11);
      if (left > 0) setTimeout(updateTimer, 500);
    }

    function showResults() {
      document.getElementById('poll').style.display='none';
      timerDiv.style.display='none';
      messageDiv.style.display='none';
      document.getElementById('results').style.display='block';

      const total = Object.values(votes).reduce((a,b)=>a+b,0);
      totalSpan.textContent = total;

      const sorted = students.map(s => ({
        ...s,
        votes: votes[s.id]||0,
        percent: total ? (votes[s.id]||0)/total*100 : 0
      })).sort((a,b)=> b.votes - a.votes || a.id - b.id);

      rankingDiv.innerHTML = sorted.map((s,i) => `
        <div class="result-item" style="background:linear-gradient(135deg, ${s.color}dd, ${s.color})">
          <div class="rank">${i<3 ? ['1st','2nd','3rd'][i] : (i+1)+'th'}</div>
          <div style="flex:1;text-align:left">
            <div style="font-size:1.6em;font-weight:700">${s.name}</div>
            <div class="nickname" style="font-size:0.9em;margin:5px 0">${s.nickname}</div>
            <div>${s.votes} lượt (${s.percent.toFixed(0)}%)</div>
            <div class="progress"><div class="bar" style="width:${s.percent}%"></div></div>
          </div>
        </div>
      `).join('');

      confetti({particleCount:500, spread:120});
    }

    // Reset cho giáo viên
    if (new URLSearchParams(location.search).get('admin')==='123') {
      document.getElementById('resetBtn').style.display='block';
      document.getElementById('resetBtn').onclick = () => {
        if(confirm('Reset toàn bộ vote và thời gian?')) {
          pollRef.set({endTime: Date.now()+duration*1000, votes:{}});
          alert('Đã reset! Cả lớp refresh để vote lại nha!');
        }
      };
    }

    // Khởi tạo thời gian nếu chưa có
    endTimeRef.once('value').then(s => {
      if(!s.val()) endTimeRef.set(Date.now() + duration*1000);
    });
  </script>
</body>
</html>