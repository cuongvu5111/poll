<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B√¨nh Ch·ªçn S·∫£n Ph·∫©m ƒê·∫πp</title>

  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.8.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.8.2/firebase-database-compat.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Baloo 2', sans-serif;
      background: linear-gradient(135deg, #a29bfe 0%, #ffeaa7 100%);
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 30px;
      padding: 40px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
    }
    h1 {
      font-size: 3em;
      margin: 10px 0 15px;
      color: #6c5ce7;
      text-shadow: 3px 3px 0px #fd79a8;
    }
    .subtitle {
      font-size: 1.5em;
      margin-bottom: 25px;
      color: #e84393;
      line-height: 1.4;
    }
    .admin-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 20px 0;
    }
    .admin-btn {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1.3em;
      font-weight: 700;
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Baloo 2', sans-serif;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }
    .admin-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.3); }
    .admin-btn.danger { background: #d63031; }
    .admin-btn.success { background: #00b894; }


    .options { 
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .option {
      background: #ddd;
      border-radius: 20px;
      padding: 25px 15px;
      cursor: pointer;
      font-size: 1.4em;
      font-weight: 700;
      color: white;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }
    .option:hover { transform: translateY(-5px) scale(1.03); }
    .option:active { transform: scale(0.98); }
    .option.selected {
      transform: scale(1.05);
      box-shadow: 0 0 40px #ffd700, 0 0 80px #ff0 !important;
      animation: pulse 1.5s infinite;
    }
    .option.disabled { opacity: 0.35; pointer-events: none; filter: grayscale(90%); }

    #message {
      font-size: 1.6em;
      min-height: 60px;
      padding: 15px;
      background: #fff3cd;
      border-radius: 20px;
      margin: 20px 0;
      color: #e17055;
      font-weight: 700;
    }

    /* Top 3 Podium */
    .top3-container {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 30px;
      margin: 50px 0;
      min-height: 400px;
    }
    .podium {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      animation: slideUp 0.8s ease-out;
    }
    @keyframes slideUp {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .podium.first { order: 2; }
    .podium.second { order: 1; }
    .podium.third { order: 3; }
    .podium-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      font-weight: 800;
      color: white;
      margin-bottom: 15px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      position: relative;
    }
    .podium.first .podium-avatar {
      width: 150px;
      height: 150px;
      font-size: 4em;
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    .crown {
      position: absolute;
      top: -40px;
      font-size: 2.5em;
      animation: rotate 3s infinite;
    }
    @keyframes rotate {
      0%, 100% { transform: rotate(-15deg); }
      50% { transform: rotate(15deg); }
    }
    .podium-name {
      font-size: 1.8em;
      font-weight: 800;
      margin: 10px 0 5px;
      color: #2d3436;
    }

    .podium-votes {
      font-size: 1.5em;
      font-weight: 700;
      color: #e17055;
      margin-bottom: 15px;
    }
    .podium-base {
      width: 180px;
      border-radius: 15px 15px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4em;
      font-weight: 800;
      color: white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .podium.first .podium-base {
      height: 200px;
      background: linear-gradient(135deg, #f1c40f, #f39c12);
      width: 200px;
    }
    .podium.second .podium-base {
      height: 150px;
      background: linear-gradient(135deg, #bdc3c7, #95a5a6);
    }
    .podium.third .podium-base {
      height: 120px;
      background: linear-gradient(135deg, #e67e22, #d35400);
    }

    .result-item {
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      color: white;
      margin: 15px 0;
      padding: 20px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      font-size: 1.3em;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    .rank { font-size: 2.5em; margin-right: 20px; min-width: 80px; }
    .progress { height: 30px; background: rgba(255,255,255,0.3); border-radius: 15px; overflow: hidden; margin-top: 10px; }
    .bar { height: 100%; background: #fff; border-radius: 15px; transition: width 1s ease; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,215,0,0.8); } 70% { box-shadow: 0 0 0 40px rgba(255,215,0,0); } }

    @media (max-width: 768px) {
      .container { padding: 20px; }
      h1 { font-size: 2em; }
      .options { grid-template-columns: 1fr; }
      .top3-container { flex-direction: column; align-items: center; gap: 20px; }
      .podium { order: unset !important; }
      .admin-controls { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® B√åNH CH·ªåN S·∫¢N PH·∫®M ƒê·∫∏P üé®</h1>
    <div class="subtitle">Ch·ªçn s·∫£n ph·∫©m m√† b·∫°n y√™u th√≠ch nh·∫•t!</div>

    <div id="adminControls" class="admin-controls" style="display:none;">
      <button id="startBtn" class="admin-btn success">üöÄ B·∫ÆT ƒê·∫¶U VOTE</button>
      <button id="endBtn" class="admin-btn danger">‚èπÔ∏è K·∫æT TH√öC NGAY</button>
      <button id="resetBtn" class="admin-btn">üîÑ RESET TO√ÄN B·ªò</button>
      <button id="qrBtn" class="admin-btn" style="background:#e84393">üì± HI·ªÜN QR CODE</button>
    </div>

    <div id="qrModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:white;padding:40px;border-radius:30px;text-align:center;max-width:500px;position:relative;">
        <button id="closeQR" style="position:absolute;top:15px;right:15px;background:#d63031;color:white;border:none;width:40px;height:40px;border-radius:50%;font-size:1.5em;cursor:pointer;font-weight:bold;">√ó</button>
        <h2 style="color:#6c5ce7;font-size:2.5em;margin-bottom:20px">üì± Qu√©t M√£ QR</h2>
        <p style="color:#e84393;font-size:1.3em;margin-bottom:20px">ƒê·ªÉ m·ªçi ng∆∞·ªùi vote ngay!</p>
        <div style="background:#f0f0f0;padding:20px;border-radius:20px;margin:20px 0;">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://capable-melomakarona-c6f045.netlify.app/" style="width:300px;height:300px;display:block;">
        </div>
        <div style="background:#fff3cd;padding:15px;border-radius:15px;word-break:break-all;font-size:1em;color:#333;margin-top:20px;">
          https://capable-melomakarona-c6f045.netlify.app/
        </div>
      </div>
    </div>

    <div id="message">Ch·ªçn s·∫£n ph·∫©m y√™u th√≠ch c·ªßa b·∫°n!</div>

    <button id="viewResultsBtn" class="admin-btn" style="background:#f39c12;display:none;margin:20px auto;">
      üìä XEM K·∫æT QU·∫¢
    </button>

    <div id="poll" class="options"></div>

    <div id="results" style="display:none;">
      <h2 style="font-size:3em;color:#f1c40f;margin:30px 0;text-shadow:3px 3px 0 #e17055">üèÜ TOP 3 S·∫¢N PH·∫®M Y√äU TH√çCH üèÜ</h2>
      <div id="top3"></div>
      
      <h2 style="font-size:2.5em;color:#6c5ce7;margin:50px 0 30px">üìä B·∫¢NG X·∫æP H·∫†NG ƒê·∫¶Y ƒê·ª¶</h2>
      <div id="ranking"></div>
      <p style="font-size:1.5em;margin-top:25px;color:#636e72">T·ªïng c·ªông <b id="total-votes" style="color:#e17055">0</b> b·∫°n ƒë√£ vote</p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAQB47nB58LyMQ1_5DZSCggJK5AhBy-POE",
      authDomain: "poll-sieu-nang-luc.firebaseapp.com",
      databaseURL: "https://poll-sieu-nang-luc-default-rtdb.firebaseio.com",
      projectId: "poll-sieu-nang-luc",
      storageBucket: "poll-sieu-nang-luc.firebasestorage.app",
      messagingSenderId: "743139357944",
      appId: "1:743139357944:web:92fe5cfc03d4414e5e370d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const pollRef = db.ref('sieunangluc-tenhocsinh-2025');
    const votesRef = pollRef.child('votes');
    const endTimeRef = pollRef.child('endTime');
    const duration = 120; // 2 ph√∫t

    // 6 nh√≥m
    const students = [
      {id: 0, name: "Nh√≥m 1", icon: "1Ô∏è‚É£", color: "#74b9ff"},
      {id: 1, name: "Nh√≥m 2", icon: "2Ô∏è‚É£", color: "#fd79a8"},
      {id: 2, name: "Nh√≥m 3", icon: "3Ô∏è‚É£", color: "#f1c40f"},
      {id: 3, name: "Nh√≥m 4", icon: "4Ô∏è‚É£", color: "#00b894"},
      {id: 4, name: "Nh√≥m 5", icon: "5Ô∏è‚É£", color: "#e17055"},
      {id: 5, name: "Nh√≥m 6", icon: "6Ô∏è‚É£", color: "#a29bfe"}
    ];

    let isVotingActive = true;
    let votes = {};
    const pollDiv = document.getElementById('poll');
    const messageDiv = document.getElementById('message');
    const rankingDiv = document.getElementById('ranking');
    const totalSpan = document.getElementById('total-votes');

    // T·∫°o c√°c √¥ vote: Icon v√† t√™n s·∫£n ph·∫©m
    students.forEach(s => {
      const div = document.createElement('div');
      div.className = 'option';
      div.dataset.id = s.id;
      div.style.background = s.color;
      div.innerHTML = `
        <div style="font-size:2.5em;margin-bottom:10px">${s.icon}</div>
        <div>${s.name}</div>
      `;
      div.onclick = () => vote(s.id);
      pollDiv.appendChild(div);
    });

    // Ki·ªÉm tra ƒë√£ vote ch∆∞a
    if (localStorage.getItem('voted_ten_2025') === 'yes') {
      const chosen = localStorage.getItem('choice_ten_2025');
      document.querySelectorAll('.option').forEach(d => {
        if (d.dataset.id == chosen) d.classList.add('selected');
        else d.classList.add('disabled');
      });
      messageDiv.innerHTML = `B·∫°n ƒë√£ vote cho <b>${students[chosen].name}</b> r·ªìi nha!`;
    }

    // Listener cho endTime - ph√°t hi·ªán khi K·∫æT TH√öC ho·∫∑c B·∫ÆT ƒê·∫¶U
    endTimeRef.on('value', snap => {
      const endTime = snap.val();
      if (endTime && endTime < Date.now()) {
        // ƒê√£ k·∫øt th√∫c - hi·ªán k·∫øt qu·∫£
        isVotingActive = false;
        votesRef.once('value').then(voteSnap => {
          votes = voteSnap.val() || {};
          showResults();
        });
      } else {
        // ƒêang m·ªü vote - reload trang ƒë·ªÉ reset giao di·ªán
        if (!isVotingActive) {
          // N·∫øu tr∆∞·ªõc ƒë√≥ ƒë√£ k·∫øt th√∫c, gi·ªù b·∫Øt ƒë·∫ßu l·∫°i -> reload
          location.reload();
        }
        isVotingActive = true;
        document.getElementById('viewResultsBtn').style.display = 'none';
      }
    });

    // Listener cho votes - ph√°t hi·ªán khi RESET (votes = null ho·∫∑c {})
    votesRef.on('value', snap => {
      const newVotes = snap.val() || {};
      const voteCount = Object.keys(newVotes).length;
      
      // N·∫øu votes b·ªã x√≥a (reset) v√† ƒëang c√≥ localStorage -> reload
      if (voteCount === 0 && localStorage.getItem('voted_ten_2025') === 'yes') {
        localStorage.removeItem('voted_ten_2025');
        localStorage.removeItem('choice_ten_2025');
        location.reload();
        return;
      }
      
      votes = newVotes;
      // N·∫øu ƒëang ·ªü tr·∫°ng th√°i k·∫øt th√∫c v√† c√≥ votes, c·∫≠p nh·∫≠t k·∫øt qu·∫£
      if (!isVotingActive && document.getElementById('results').style.display === 'block') {
        showResults();
      }
    });

    function vote(id) {
      if (localStorage.getItem('voted_ten_2025') === 'yes' || !isVotingActive) return;

      votesRef.child(id).transaction(v => (v||0)+1);
      localStorage.setItem('voted_ten_2025','yes');
      localStorage.setItem('choice_ten_2025',id);

      messageDiv.innerHTML = `Vote cho <b>${students[id].name}</b> th√†nh c√¥ng!`;
      confetti({particleCount:250, spread:100});
      new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3').play().catch(()=>{});

      document.querySelectorAll('.option').forEach(d => {
        if (d.dataset.id == id) d.classList.add('selected');
        else d.classList.add('disabled');
      });
    }

    function showResults() {
      document.getElementById('poll').style.display='none';
      messageDiv.style.display='none';
      document.getElementById('results').style.display='block';

      const total = Object.values(votes).reduce((a,b)=>a+b,0);
      totalSpan.textContent = total;

      const sorted = students.map(s => ({
        ...s,
        votes: votes[s.id]||0,
        percent: total ? (votes[s.id]||0)/total*100 : 0
      })).sort((a,b)=> b.votes - a.votes || a.id - b.id);

      // Hi·ªÉn th·ªã Top 3 v·ªõi podium
      const top3Div = document.getElementById('top3');
      const top3 = sorted.slice(0, 3);
      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const positions = ['first', 'second', 'third'];
      
      top3Div.innerHTML = `
        <div class="top3-container">
          ${top3.map((s, i) => `
            <div class="podium ${positions[i]}">
              ${i === 0 ? '<div class="crown">üëë</div>' : ''}
              <div class="podium-avatar" style="background:${s.color}">
                ${s.icon}
              </div>
              <div class="podium-name">${s.name}</div>
              <div class="podium-votes">${s.votes} votes (${s.percent.toFixed(1)}%)</div>
              <div class="podium-base">
                ${medals[i]}
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // Hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng ƒë·∫ßy ƒë·ªß (t·ª´ v·ªã tr√≠ 4 tr·ªü ƒëi)
      rankingDiv.innerHTML = sorted.slice(3).map((s,i) => `
        <div class="result-item" style="background:linear-gradient(135deg, ${s.color}dd, ${s.color})">
          <div class="rank">${i+4}th</div>
          <div style="flex:1;text-align:left">
            <div style="font-size:1.4em;font-weight:700">
              <span style="font-size:1.5em;margin-right:10px">${s.icon}</span>${s.name}
            </div>
            <div style="font-size:1.1em;margin-top:8px">${s.votes} l∆∞·ª£t (${s.percent.toFixed(1)}%)</div>
            <div class="progress"><div class="bar" style="width:${s.percent}%"></div></div>
          </div>
        </div>
      `).join('');

      // Hi·ªáu ·ª©ng confetti
      confetti({particleCount:500, spread:120, origin:{y:0.6}});
      setTimeout(() => confetti({particleCount:300, spread:100, origin:{y:0.7}}), 500);
    }

    // N√∫t ƒëi·ªÅu khi·ªÉn cho gi√°o vi√™n
    if (new URLSearchParams(location.search).get('admin')==='123') {
      document.getElementById('adminControls').style.display='flex';
      
      // N√∫t B·∫ÆT ƒê·∫¶U - M·ªü vote
      document.getElementById('startBtn').onclick = () => {
        if(confirm('B·∫Øt ƒë·∫ßu vote m·ªõi?')) {
          pollRef.update({endTime: Date.now() + (365*24*60*60*1000)}).then(() => {
            alert('ƒê√£ b·∫Øt ƒë·∫ßu! T·∫•t c·∫£ m√†n h√¨nh s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t!');
            location.reload();
          });
        }
      };
      
      // N√∫t K·∫æT TH√öC - D·ª´ng vote ngay l·∫≠p t·ª©c v√† hi·ªán k·∫øt qu·∫£
      document.getElementById('endBtn').onclick = () => {
        if(confirm('K·∫øt th√∫c vote ngay v√† hi·ªÉn th·ªã k·∫øt qu·∫£?')) {
          pollRef.update({endTime: Date.now() - 1000}).then(() => {
            isVotingActive = false;
            // Load votes v√† hi·ªán k·∫øt qu·∫£ ngay
            votesRef.once('value').then(snap => {
              votes = snap.val() || {};
              showResults();
            });
          });
        }
      };
      
      // N√∫t RESET - X√≥a to√†n b·ªô d·ªØ li·ªáu v√† b·∫Øt ƒë·∫ßu l·∫°i
      document.getElementById('resetBtn').onclick = () => {
        if(confirm('‚ö†Ô∏è RESET to√†n b·ªô vote?\n(T·∫•t c·∫£ d·ªØ li·ªáu s·∫Ω b·ªã x√≥a)')) {
          pollRef.set({endTime: Date.now() + (365*24*60*60*1000), votes:{}}).then(() => {
            localStorage.removeItem('voted_ten_2025');
            localStorage.removeItem('choice_ten_2025');
            alert('‚úÖ ƒê√£ reset! T·∫•t c·∫£ m√†n h√¨nh s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t!');
            location.reload();
          });
        }
      };

      // N√∫t HI·ªÜN QR CODE
      const qrModal = document.getElementById('qrModal');
      document.getElementById('qrBtn').onclick = () => {
        qrModal.style.display = 'flex';
      };
      document.getElementById('closeQR').onclick = () => {
        qrModal.style.display = 'none';
      };
      qrModal.onclick = (e) => {
        if(e.target === qrModal) qrModal.style.display = 'none';
      };
    }

    // N√∫t xem k·∫øt qu·∫£ cho h·ªçc sinh
    document.getElementById('viewResultsBtn').onclick = () => {
      votesRef.once('value').then(snap => {
        votes = snap.val() || {};
        showResults();
      });
    };

    // Kh·ªüi t·∫°o tr·∫°ng th√°i vote n·∫øu ch∆∞a c√≥
    endTimeRef.once('value').then(s => {
      if(!s.val()) endTimeRef.set(Date.now() + (365*24*60*60*1000)); // M·∫∑c ƒë·ªãnh m·ªü vote
    });
  </script>
</body>
</html>